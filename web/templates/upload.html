{{define "upload.content"}}
<div class="container upload">
  <h2 class="page-title">beitrag hochladen</h2>

  <form action="/upload?token={{.Token}}" method="POST" enctype="multipart/form-data" id="uploadForm">
      <input type="hidden" name="token" value="{{.Token}}">
      <div class="form-group">
        <label for="deriveInput">aufgabe</label>
        <input list="derivenList" name="derive_number" id="deriveInput" class="autocomplete-input" placeholder="suche..." required>
        <datalist id="derivenList">
          {{range .Deriven}}
          <option value="{{.Number}}">{{.Title}}</option>
          {{end}}
        </datalist>
      </div>

      <div class="form-group">
        <label>bild</label>
        <div id="drop-zone">
          <span id="drop-text">bild ablegen oder klicken</span>
          <input type="file" name="image" id="fileInput" hidden accept="image/*" required>
          <img id="preview" src="#" alt="Preview">
        </div>
      </div>

      <button type="submit" class="btn-black submit-btn" id="submitBtn">hochladen</button>
    </form>
  </div>

  <script>
    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('fileInput');
    const pr = document.getElementById('preview');
    const dt = document.getElementById('drop-text');

    dz.addEventListener('click', () => fi.click());

    dz.addEventListener('dragover', (e) => {
      e.preventDefault();
      dz.classList.add('active');
    });

    dz.addEventListener('dragleave', () => dz.classList.remove('active'));

    dz.addEventListener('drop', (e) => {
      e.preventDefault();
      dz.classList.remove('active');
      if (e.dataTransfer.files.length) {
        fi.files = e.dataTransfer.files;
        updatePreview(e.dataTransfer.files[0]);
      }
    });

    fi.addEventListener('change', (e) => {
      if (e.target.files.length) updatePreview(e.target.files[0]);
    });

    function updatePreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        pr.src = e.target.result;
        pr.style.display = 'block';
        dt.style.display = 'none';
      }
      reader.readAsDataURL(file);
    }

    document.getElementById('uploadForm').onsubmit = function() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "optimiere...";
    };

    // Prefill derive if present in query param
    (function(){
      try {
        const params = new URLSearchParams(location.search);
        const d = params.get('derive');
        if (d) {
          const el = document.getElementById('deriveInput');
          if (el) el.value = d;
        }
      } catch (e) { /* ignore */ }
    })();

    // deleteSessionUpload removed per request; session uploads can no longer be deleted by users from the client.

  </script>

  <!-- Session uploads -->
  {{if .SessionContribs}}
  <div style="margin-top:1.5rem;">
    <h3>Deine Uploads in dieser Session</h3>
    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
      {{range .SessionContribs}}
      <div style="width:120px;text-align:center;" id="session-upload-{{.id}}">
        <img src="{{.image_url}}" style="width:100%;height:80px;object-fit:cover;border-radius:6px;" alt="upload">
        <div style="font-size:0.85rem;margin-top:0.3rem;">#{{.derive}}</div>

      </div>
      {{end}}
    </div>
  </div>
  {{end}}
</div>
{{end}}