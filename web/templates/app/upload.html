{{define "upload.content"}}
<div class="container upload">
  <div class="current-player">{{if .CurrentPlayer}}üë§ {{.CurrentPlayer}}{{end}}</div>
  <h2 class="page-title">Beweisfoto hochladen</h2>

  <form action="/upload?token={{.Token}}" method="POST" enctype="multipart/form-data" id="uploadForm">
      <input type="hidden" name="token" value="{{.Token}}">
      <div class="form-group">
        <label for="deriveInput">Aufgabe</label>
        <select name="derive_number" id="deriveInput" class="autocomplete-input" required>
          <option value="" disabled {{if not .SelectedNumber}}selected{{end}}>Bitte w√§hlen...</option>
          {{range .Deriven}}
          <option value="{{.Number}}" {{if index $.UploadedNumbers (printf "%d" .Number)}}disabled class="uploaded" title="Du hast bereits hochgeladen"{{end}} {{if eq $.SelectedNumber (printf "%d" .Number)}}selected{{end}}>üÜî {{.Number}}{{if index $.UploadedNumbers (printf "%d" .Number)}} (hast du schon bearbeitet){{end}}</option>
          {{end}}
        </select>
        <small class="form-note">F√ºr ausgegraute IDs existiert bereits ein Beweisfoto von dir.</small>
      </div>

      <div class="form-group">
        <label>Bild</label>
        <div id="drop-zone">
          <span id="drop-text">Bild ablegen oder klicken</span>
          <input type="file" name="image" id="fileInput" hidden accept="image/*" required>
          <img id="preview" src="#" alt="Preview">
        </div>
      </div>

      <div class="form-group">
        <label for="commentInput">Kurzer Kommentar (optional, max. 100 Zeichen)</label>
        <input type="text" name="comment" id="commentInput" class="form-input" maxlength="100" placeholder="z.B. Ort, Besonderheit, ...">
        <small class="form-note"><span id="charCount">0</span>/100</small>
      </div>

      <button type="submit" class="btn-black submit-btn" id="submitBtn">hochladen</button>
    </form>

  <!-- Punktzahl -->
  <div class="score-display">
    <p class="score-text">Deine Punktzahl: <strong class="score-value">{{.TotalPoints}}</strong></p>
  </div>

  <!-- Session Management -->
  <div class="session-management">
    <details class="session-details">
      <summary>Werkzeug-Verwaltung</summary>
      <div class="session-content">
        <div class="session-actions">
          <button type="button" class="btn-secondary" onclick="releaseBag()">
            üéí Werkzeug zur√ºckgeben
          </button>
          <button type="button" class="btn-secondary" onclick="showInvitationModal()">
            üì® Jemanden einladen
          </button>
          <button type="button" class="btn-secondary" onclick="showActiveSessions()">
            üë• Aktive Sitzungen
          </button>
        </div>
        <p class="session-info">
          Du kannst das Werkzeug zur√ºckgeben, um es anderen zu erm√∂glichen, oder Freunde einladen, gleichzeitig mitzuspielen.
        </p>
      </div>
    </details>
  </div>

  <!-- Invitation Modal -->
  <div id="invitationModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeInvitationModal()">&times;</span>
      <h3>Einladung erstellen</h3>
      <p>Generiere einen Einladungscode, um jemanden zum gemeinsamen Spielen einzuladen.</p>
      <button type="button" class="btn-black" onclick="generateInvitation()">Code generieren</button>
      <div id="invitationResult" style="display: none; margin-top: 1rem;">
        <p>Einladungscode:</p>
        <div class="code-display">
          <code id="invitationCode"></code>
          <button type="button" onclick="copyInvitationCode()" class="btn-copy">üìã Kopieren</button>
        </div>
        <p class="code-note">Dieser Code ist 24 Stunden g√ºltig.</p>
      </div>
    </div>
  </div>

  <!-- Active Sessions Modal -->
  <div id="sessionsModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeSessionsModal()">&times;</span>
      <h3>Aktive Sitzungen</h3>
      <div id="sessionsList"></div>
    </div>
  </div>

  <script>
    // Release bag function
    async function releaseBag() {
      if (!confirm('M√∂chtest du das Werkzeug wirklich zur√ºckgeben? Damit erlaubst du anderen, es zu verwenden.')) return;
      
      try {
        const params = new URLSearchParams(location.search);
        const token = params.get('token') || '';
        const response = await fetch(`/session/release?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          alert('Werkzeug erfolgreich zur√ºckgegeben!');
          location.href = '/';
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      } catch (err) {
        alert('Fehler: ' + err.message);
      }
    }

    // Invitation modal functions
    function showInvitationModal() {
      document.getElementById('invitationModal').style.display = 'block';
      document.getElementById('invitationResult').style.display = 'none';
    }

    function closeInvitationModal() {
      document.getElementById('invitationModal').style.display = 'none';
    }

    async function generateInvitation() {
      try {
        const params = new URLSearchParams(location.search);
        const token = params.get('token') || '';
        const response = await fetch(`/session/invitation/generate?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          document.getElementById('invitationCode').textContent = data.code;
          document.getElementById('invitationResult').style.display = 'block';
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      } catch (err) {
        alert('Fehler: ' + err.message);
      }
    }

    function copyInvitationCode() {
      const code = document.getElementById('invitationCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert('Code in Zwischenablage kopiert!');
      }).catch(err => {
        alert('Fehler beim Kopieren: ' + err.message);
      });
    }

    // Active sessions functions
    async function showActiveSessions() {
      try {
        const params = new URLSearchParams(location.search);
        const token = params.get('token') || '';
        const response = await fetch(`/session/active?token=${encodeURIComponent(token)}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          displayActiveSessions(data.sessions);
          document.getElementById('sessionsModal').style.display = 'block';
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      } catch (err) {
        alert('Fehler: ' + err.message);
      }
    }

    function displayActiveSessions(sessions) {
      const sessionsList = document.getElementById('sessionsList');
      if (!sessions || sessions.length === 0) {
        sessionsList.innerHTML = '<p>Keine aktiven Sitzungen.</p>';
        return;
      }

      let html = '<div class="sessions-list">';
      sessions.forEach(session => {
        html += `
          <div class="session-item ${session.is_current ? 'current' : ''}">
            <div class="session-info">
              <strong>${session.player_name}</strong>
              ${session.player_city ? ` aus ${session.player_city}` : ''}
              ${session.is_owner ? ' <span class="badge">Eigent√ºmer</span>' : ''}
              ${session.is_current ? ' <span class="badge current">Du</span>' : ''}
            </div>
            <div class="session-meta">
              <small>Zuletzt aktiv: ${new Date(session.last_active_at).toLocaleString('de-DE')}</small>
            </div>
            ${!session.is_owner && !session.is_current ? `
              <button class="btn-revoke" onclick="revokeSession(${session.id})">Zugriff entziehen</button>
            ` : ''}
          </div>
        `;
      });
      html += '</div>';
      sessionsList.innerHTML = html;
    }

    async function revokeSession(sessionId) {
      if (!confirm('M√∂chtest du dieser Sitzung wirklich den Zugriff entziehen?')) return;
      
      try {
        const params = new URLSearchParams(location.search);
        const token = params.get('token') || '';
        const response = await fetch(`/session/revoke/${sessionId}?token=${encodeURIComponent(token)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          alert('Zugriff erfolgreich entzogen!');
          showActiveSessions(); // Refresh the list
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      } catch (err) {
        alert('Fehler: ' + err.message);
      }
    }

    function closeSessionsModal() {
      document.getElementById('sessionsModal').style.display = 'none';
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const invModal = document.getElementById('invitationModal');
      const sessModal = document.getElementById('sessionsModal');
      if (event.target === invModal) {
        closeInvitationModal();
      }
      if (event.target === sessModal) {
        closeSessionsModal();
      }
    }
  </script>

  <style>
    .session-management {
      margin: 2rem 0;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .session-details summary {
      cursor: pointer;
      font-weight: 600;
      padding: 0.5rem;
      list-style: none;
      user-select: none;
    }

    .session-details summary::-webkit-details-marker {
      display: none;
    }

    .session-details summary::before {
      content: "‚ñ∂ ";
      display: inline-block;
      transition: transform 0.2s;
    }

    .session-details[open] summary::before {
      transform: rotate(90deg);
    }

    .session-content {
      margin-top: 1rem;
    }

    .session-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .btn-secondary {
      padding: 0.5rem 1rem;
      background: white;
      border: 2px solid #333;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-secondary:hover {
      background: #333;
      color: white;
    }

    .session-info {
      font-size: 0.9rem;
      color: #666;
      margin: 0;
    }

    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 2rem;
      border: 1px solid #888;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
    }

    .code-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 6px;
      margin: 0.5rem 0;
    }

    .code-display code {
      flex: 1;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 2px;
      font-family: monospace;
    }

    .btn-copy {
      padding: 0.5rem 1rem;
      background: #0984e3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-copy:hover {
      background: #0770c7;
    }

    .code-note {
      font-size: 0.85rem;
      color: #666;
      font-style: italic;
    }

    .sessions-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .session-item {
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 6px;
      border: 2px solid #e9ecef;
    }

    .session-item.current {
      background: #e7f5ff;
      border-color: #0984e3;
    }

    .session-info {
      margin-bottom: 0.5rem;
    }

    .session-meta {
      color: #666;
      font-size: 0.85rem;
    }

    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      background: #333;
      color: white;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: normal;
    }

    .badge.current {
      background: #0984e3;
    }

    .btn-revoke {
      margin-top: 0.5rem;
      padding: 0.4rem 0.8rem;
      background: #d63031;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .btn-revoke:hover {
      background: #c0261e;
    }
  </style>

  <script>
    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('fileInput');
    const pr = document.getElementById('preview');
    const dt = document.getElementById('drop-text');

    dz.addEventListener('click', () => fi.click());

    dz.addEventListener('dragover', (e) => {
      e.preventDefault();
      dz.classList.add('active');
    });

    dz.addEventListener('dragleave', () => dz.classList.remove('active'));

    dz.addEventListener('drop', (e) => {
      e.preventDefault();
      dz.classList.remove('active');
      if (e.dataTransfer.files.length) {
        fi.files = e.dataTransfer.files;
        updatePreview(e.dataTransfer.files[0]);
      }
    });

    fi.addEventListener('change', (e) => {
      if (e.target.files.length) updatePreview(e.target.files[0]);
    });

    // Character counter for comment
    const commentInput = document.getElementById('commentInput');
    const charCount = document.getElementById('charCount');
    if (commentInput && charCount) {
      commentInput.addEventListener('input', (e) => {
        charCount.textContent = e.target.value.length;
      });
    }

    function updatePreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        pr.src = e.target.result;
        pr.style.display = 'block';
        dt.style.display = 'none';
      }
      reader.readAsDataURL(file);
    }

    document.getElementById('uploadForm').onsubmit = function() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "optimiere...";
    };

    // Prefill number if present in query param
    (function(){
      try {
        const params = new URLSearchParams(location.search);
        const d = params.get('number');
        if (d) {
          const el = document.getElementById('deriveInput');
          if (el) {
            el.value = d;
            // don't leave a disabled (already-uploaded) option selected
            const selectedOpt = el.querySelector('option[value="' + d + '"]');
            if (selectedOpt && selectedOpt.disabled) {
              el.value = '';
            }
          }
        }

        // If redirected after successful upload, clear selection and reset form
        const uploaded = params.get('uploaded');
        if (uploaded === '1') {
          const el = document.getElementById('deriveInput');
          const fileInput = document.getElementById('fileInput');
          const preview = document.getElementById('preview');
          const dropText = document.getElementById('drop-text');
          const submitBtn = document.getElementById('submitBtn');
          // clear selection
          if (el) el.value = '';
          // reset file input & preview
          if (fileInput) {
            try { fileInput.value = null; } catch(e) { /* ignore */ }
          }
          if (preview) {
            preview.src = '#';
            preview.style.display = 'none';
          }
          if (dropText) dropText.style.display = 'block';
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerText = 'hochladen';
          }
          // show temporary success message
          let result = document.getElementById('uploadResult');
          if (!result) {
            result = document.createElement('div');
            result.id = 'uploadResult';
            result.style.marginTop = '1rem';
            result.style.fontWeight = '500';
            document.querySelector('.container.upload').insertBefore(result, document.querySelector('.session-uploads'));
          }
          result.innerText = 'Upload erfolgreich!';
          result.style.color = '#2e7d32';
          result.style.display = 'block';
          setTimeout(() => {
            if (result) result.style.display = 'none';
          }, 4000);

          // Remove uploaded param from URL to avoid repeated behavior on refresh
          try {
            params.delete('uploaded');
            const newUrl = location.pathname + (params.toString() ? '?' + params.toString() : '');
            history.replaceState(null, '', newUrl);
          } catch(e) { /* ignore */ }
        }

      } catch (e) { /* ignore */ }
    })();

    // Delete session upload
    async function deleteSessionUpload(id, btn) {
      if (!confirm('Upload wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) return;
      
      try {
        const params = new URLSearchParams(location.search);
        const token = params.get('token') || '';
        const response = await fetch(`/upload/contributions/${id}/delete?token=${encodeURIComponent(token)}`, { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          // Reload page to update uploaded numbers and points
          location.reload();
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      } catch (err) {
        alert('Fehler: ' + err.message);
      }
    }

  </script>

  <!-- Session uploads -->
  {{if .SessionContribs}}
  <div class="session-uploads">
    <h3>Deine Uploads in dieser Session</h3>
    <div class="session-grid">
      {{range .SessionContribs}}
      <div class="session-card" id="session-upload-{{index . "id"}}">
        <div class="session-img-wrapper">
          <img class="lazy blur-up" data-src="{{index . "image_url"}}" data-lqip="{{index . "image_lqip"}}" src="{{if index . "image_lqip"}}{{index . "image_lqip"}}{{else}}data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='6'/>{{end}}" loading="lazy" alt="upload">
        </div>
        <div class="session-meta">
          üÜî {{index . "number"}}
          <button class="session-delete-btn" onclick="deleteSessionUpload({{index . "id"}}, this)" title="L√∂schen">üóëÔ∏è</button>
        </div>
      </div>
      {{end}}
    </div>
  </div>
  {{end}}
</div>
{{end}}