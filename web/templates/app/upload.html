{{define "upload.content"}}
<div class="container upload">
  <div class="current-player">{{if .CurrentPlayer}}ğŸ‘¤ {{.CurrentPlayer}}{{end}}</div>
  <h2 class="page-title">Beweisfoto hochladen</h2>

  <form action="/upload?token={{.Token}}" method="POST" enctype="multipart/form-data" id="uploadForm">
      <input type="hidden" name="token" value="{{.Token}}">
      {{if .CSRFToken}}<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">{{end}}
      <div class="form-group">
        <label for="deriveInput">Aufgabe</label>
        <select name="derive_number" id="deriveInput" class="autocomplete-input" required>
          <option value="" disabled {{if not .SelectedNumber}}selected{{end}}>Bitte wÃ¤hlen...</option>
          {{range .Deriven}}
          <option value="{{.Number}}" {{if index $.UploadedNumbers (printf "%d" .Number)}}disabled class="uploaded" title="Du hast bereits hochgeladen"{{end}} {{if eq $.SelectedNumber (printf "%d" .Number)}}selected{{end}}>ğŸ†” {{.Number}}{{if index $.UploadedNumbers (printf "%d" .Number)}} (hast du schon bearbeitet){{end}}</option>
          {{end}}
        </select>
        <small class="form-note">FÃ¼r ausgegraute IDs existiert bereits ein Beweisfoto von dir.</small>
      </div>

      <div class="form-group">
        <label>Bild</label>
        <div id="drop-zone">
          <span id="drop-text">Bild ablegen oder klicken</span>
          <input type="file" name="image" id="fileInput" hidden accept="image/*" required>
          <img id="preview" src="#" alt="Preview">
        </div>
      </div>

      <div class="form-group">
        <label for="commentInput">Kurzer Kommentar (optional, max. 100 Zeichen)</label>
        <input type="text" name="comment" id="commentInput" class="form-input" maxlength="100" placeholder="z.B. Ort, Besonderheit, ...">
        <small class="form-note"><span id="charCount">0</span>/100</small>
      </div>

      <button type="submit" class="btn-black submit-btn" id="submitBtn">hochladen</button>
    </form>

  <!-- Session Management -->
  <div class="session-management">
    <h3 class="section-title">Werkzeug-Verwaltung</h3>
    <div class="management-buttons">
      <a href="/upload/sessions" class="management-btn btn-sessions">
        <span class="btn-icon">ğŸ‘¥</span>
        <span class="btn-text">Aktive Sitzungen anzeigen</span>
      </a>
      <button type="button" class="management-btn btn-invite" onclick="generateInvitation()">
        <span class="btn-icon">â•</span>
        <span class="btn-text">Andere einladen</span>
      </button>
      <form action="/upload/release" method="POST" class="release-form" onsubmit="return confirm('MÃ¶chtest du das Werkzeug wirklich zurÃ¼ckgeben? Du musst danach den QR-Code erneut scannen.');">
        {{if .CSRFToken}}<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">{{end}}
        <button type="submit" class="management-btn btn-release">
          <span class="btn-icon">ğŸ”“</span>
          <span class="btn-text">Werkzeug zurÃ¼ckgeben</span>
        </button>
      </form>
    </div>
  </div>

  <!-- Punktzahl -->
  <div class="score-display">
    <p class="score-text">Deine Punktzahl: <strong class="score-value">{{.TotalPoints}}</strong></p>
  </div>

  <!-- Invitation Modal -->
  <div id="invitationModal" class="invitation-modal">
    <div class="invitation-modal-content">
      <div class="invitation-modal-header">
        <h3 class="invitation-modal-title">âœ‰ï¸ Einladung erstellt!</h3>
        <button class="invitation-modal-close" onclick="closeInvitationModal()">Ã—</button>
      </div>
      <div class="invitation-modal-body">
        <div class="invitation-info-item">
          <span class="invitation-info-label">Einladungscode</span>
          <span class="invitation-info-value" id="invitationCode"></span>
        </div>
        <div class="invitation-info-item">
          <span class="invitation-info-label">Link zum EinlÃ¶sen</span>
          <span class="invitation-info-value" id="invitationLink"></span>
        </div>
        <div class="invitation-info-item">
          <span class="invitation-info-label">GÃ¼ltig bis</span>
          <span class="invitation-info-value" id="invitationExpiry"></span>
        </div>
      </div>
      <div class="invitation-actions">
        <button class="invitation-btn invitation-btn-primary" id="copyCodeBtn" onclick="copyInvitationCode()">
          ğŸ“‹ Code kopieren
        </button>
        <button class="invitation-btn invitation-btn-primary" id="copyLinkBtn" onclick="copyInvitationLink()">
          ğŸ”— Link kopieren
        </button>
        <button class="invitation-btn invitation-btn-primary" id="copyBothBtn" onclick="copyBoth()">
          ğŸ“‹ Code und Link kopieren
        </button>
        <button class="invitation-btn invitation-btn-secondary" id="shareBtn" onclick="shareInvitation()" style="display: none;">
          ğŸ“¤ Teilen
        </button>
      </div>
    </div>
  </div>

  <script>
    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('fileInput');
    const pr = document.getElementById('preview');
    const dt = document.getElementById('drop-text');

    dz.addEventListener('click', () => fi.click());

    dz.addEventListener('dragover', (e) => {
      e.preventDefault();
      dz.classList.add('active');
    });

    dz.addEventListener('dragleave', () => dz.classList.remove('active'));

    dz.addEventListener('drop', (e) => {
      e.preventDefault();
      dz.classList.remove('active');
      if (e.dataTransfer.files.length) {
        fi.files = e.dataTransfer.files;
        updatePreview(e.dataTransfer.files[0]);
      }
    });

    fi.addEventListener('change', (e) => {
      if (e.target.files.length) updatePreview(e.target.files[0]);
    });

    // Character counter for comment
    const commentInput = document.getElementById('commentInput');
    const charCount = document.getElementById('charCount');
    if (commentInput && charCount) {
      commentInput.addEventListener('input', (e) => {
        charCount.textContent = e.target.value.length;
      });
    }

    function updatePreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        pr.src = e.target.result;
        pr.style.display = 'block';
        dt.style.display = 'none';
      }
      reader.readAsDataURL(file);
    }

    document.getElementById('uploadForm').onsubmit = function() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "optimiere...";
    };

    // Prefill number if present in query param
    (function(){
      try {
        const params = new URLSearchParams(location.search);
        const d = params.get('number');
        if (d) {
          const el = document.getElementById('deriveInput');
          if (el) {
            el.value = d;
            // don't leave a disabled (already-uploaded) option selected
            const selectedOpt = el.querySelector('option[value="' + d + '"]');
            if (selectedOpt && selectedOpt.disabled) {
              el.value = '';
            }
          }
        }

        // If redirected after successful upload, clear selection and reset form
        const uploaded = params.get('uploaded');
        if (uploaded === '1') {
          const el = document.getElementById('deriveInput');
          const fileInput = document.getElementById('fileInput');
          const preview = document.getElementById('preview');
          const dropText = document.getElementById('drop-text');
          const submitBtn = document.getElementById('submitBtn');
          // clear selection
          if (el) el.value = '';
          // reset file input & preview
          if (fileInput) {
            try { fileInput.value = null; } catch(e) { /* ignore */ }
          }
          if (preview) {
            preview.src = '#';
            preview.style.display = 'none';
          }
          if (dropText) dropText.style.display = 'block';
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerText = 'hochladen';
          }
          // show temporary success message
          let result = document.getElementById('uploadResult');
          if (!result) {
            result = document.createElement('div');
            result.id = 'uploadResult';
            result.style.marginTop = '1rem';
            result.style.fontWeight = '500';
            document.querySelector('.container.upload').insertBefore(result, document.querySelector('.session-uploads'));
          }
          result.innerText = 'Upload erfolgreich!';
          result.style.color = '#2e7d32';
          result.style.display = 'block';
          setTimeout(() => {
            if (result) result.style.display = 'none';
          }, 4000);

          // Remove uploaded param from URL to avoid repeated behavior on refresh
          try {
            params.delete('uploaded');
            const newUrl = location.pathname + (params.toString() ? '?' + params.toString() : '');
            history.replaceState(null, '', newUrl);
          } catch(e) { /* ignore */ }
        }

      } catch (e) { /* ignore */ }
    })();

    // Delete session upload
    async function deleteSessionUpload(id, btn) {
      if (!confirm('Upload wirklich lÃ¶schen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) return;
      
      try {
        const params = new URLSearchParams(location.search);
        const token = params.get('token') || '';
        const response = await fetch(`/upload/contributions/${id}/delete?token=${encodeURIComponent(token)}`, { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        const data = await response.json();
        
        if (response.ok) {
          // Reload page to update uploaded numbers and points
          location.reload();
        } else {
          alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
        }
      } catch (err) {
        alert('Fehler: ' + err.message);
      }
    }

    // Generate invitation code and show modal
    let currentInvitation = {};
    
    async function generateInvitation() {
      try {
        const csrfToken = '{{.CSRFToken}}';
        const response = await fetch('/upload/invitations/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          }
        });

        if (!response.ok) {
          throw new Error('Fehler beim Erstellen der Einladung');
        }

        const data = await response.json();
        const code = data.invitation_code;
        const expiresAt = new Date(data.expires_at).toLocaleString('de-DE');
        const inviteLink = window.location.origin + '/einladung-annehmen';
        
        // Store invitation data
        currentInvitation = { code, inviteLink, expiresAt };
        
        // Update modal content
        document.getElementById('invitationCode').textContent = code;
        document.getElementById('invitationLink').textContent = inviteLink;
        document.getElementById('invitationExpiry').textContent = expiresAt;
        
        // Show share button if Web Share API is available
        if (navigator.share) {
          document.getElementById('shareBtn').style.display = 'flex';
        }
        
        // Show modal
        document.getElementById('invitationModal').classList.add('active');
      } catch (err) {
        alert('Fehler beim Erstellen der Einladung: ' + err.message);
      }
    }
    
    function closeInvitationModal() {
      document.getElementById('invitationModal').classList.remove('active');
      // Reset button states
      resetButtonStates();
    }
    
    function resetButtonStates() {
      ['copyCodeBtn', 'copyLinkBtn', 'copyBothBtn'].forEach(id => {
        const btn = document.getElementById(id);
        btn.classList.remove('copied');
        btn.textContent = btn.textContent.replace('âœ… ', '').replace('ğŸ“‹ ', 'ğŸ“‹ ').replace('ğŸ”— ', 'ğŸ”— ');
      });
    }
    
    async function copyInvitationCode() {
      try {
        await navigator.clipboard.writeText(currentInvitation.code);
        showCopiedState('copyCodeBtn', 'âœ… Code kopiert!');
      } catch (err) {
        // Fallback
        prompt('Code kopieren:', currentInvitation.code);
      }
    }
    
    async function copyInvitationLink() {
      try {
        await navigator.clipboard.writeText(currentInvitation.inviteLink);
        showCopiedState('copyLinkBtn', 'âœ… Link kopiert!');
      } catch (err) {
        prompt('Link kopieren:', currentInvitation.inviteLink);
      }
    }
    
    async function copyBoth() {
      const text = `Einladungscode: ${currentInvitation.code}\nLink: ${currentInvitation.inviteLink}`;
      try {
        await navigator.clipboard.writeText(text);
        showCopiedState('copyBothBtn', 'âœ… Kopiert!');
      } catch (err) {
        prompt('Code und Link kopieren:', text);
      }
    }
    
    async function shareInvitation() {
      try {
        await navigator.share({
          title: 'ID-100 Werkzeug Einladung',
          text: `Hier ist der Einladungscode: ${currentInvitation.code}\n\nVerwende diesen Link zum EinlÃ¶sen:`,
          url: currentInvitation.inviteLink
        });
      } catch (err) {
        if (err.name !== 'AbortError') {
          console.error('Fehler beim Teilen:', err);
        }
      }
    }
    
    function showCopiedState(buttonId, text) {
      const btn = document.getElementById(buttonId);
      btn.classList.add('copied');
      const originalText = btn.textContent;
      btn.textContent = text;
      setTimeout(() => {
        btn.classList.remove('copied');
        btn.textContent = originalText;
      }, 2000);
    }
    
    // Close modal when clicking outside
    document.getElementById('invitationModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeInvitationModal();
      }
    });

  </script>

  <!-- Session uploads -->
  {{if .SessionContribs}}
  <div class="session-uploads">
    <h3>Deine Uploads in dieser Session</h3>
    <div class="session-grid">
      {{range .SessionContribs}}
      <div class="session-card" id="session-upload-{{index . "id"}}">
        <div class="session-img-wrapper">
          <img class="lazy blur-up" data-src="{{index . "image_url"}}" data-lqip="{{index . "image_lqip"}}" src="{{if index . "image_lqip"}}{{index . "image_lqip"}}{{else}}data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='6'/>{{end}}" loading="lazy" alt="upload">
        </div>
        <div class="session-meta">
          ğŸ†” {{index . "number"}}
          <button class="session-delete-btn" onclick="deleteSessionUpload({{index . "id"}}, this)" title="LÃ¶schen">ğŸ—‘ï¸</button>
        </div>
      </div>
      {{end}}
    </div>
  </div>
  {{end}}
</div>
{{end}}