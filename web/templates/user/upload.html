{{define "user/upload.content"}}
<div class="container upload">
  <div class="current-player">{{if .CurrentPlayer}}ðŸ‘¤ {{.CurrentPlayer}}{{end}}</div>
  {{if .CurrentPlayer}}
  <div style="display:inline-block; margin-left:1rem;">
    <button type="button" id="releaseBagBtn" class="btn-transparent">Tasche zurÃ¼ckgeben / Spiel fertig</button>
    <button type="button" id="invitePlayerBtn" class="btn-transparent" style="margin-left:0.5rem;">ðŸ‘¥ Spieler einladen</button>
    <button type="button" id="manageSessionsBtn" class="btn-transparent" style="margin-left:0.5rem;">ðŸ”§ Sessions verwalten</button>
  </div>
  {{end}}
  <h2 class="page-title">Beweisfoto hochladen</h2>

  <form action="/upload?token={{.Token}}" method="POST" enctype="multipart/form-data" id="uploadForm">
      <input type="hidden" name="token" value="{{.Token}}">
      <div class="form-group">
        <label for="deriveInput">Aufgabe</label>
        <select name="derive_number" id="deriveInput" class="autocomplete-input" required>
          <option value="" disabled {{if not .SelectedNumber}}selected{{end}}>Bitte wÃ¤hlen...</option>
          {{range .Deriven}}
          <option value="{{.Number}}" {{if index $.UploadedNumbers (printf "%d" .Number)}}disabled class="uploaded" title="Du hast bereits hochgeladen"{{end}} {{if eq $.SelectedNumber (printf "%d" .Number)}}selected{{end}}>ðŸ†” {{.Number}}{{if index $.UploadedNumbers (printf "%d" .Number)}} (hast du schon bearbeitet){{end}}</option>
          {{end}}
        </select>
        <small style="display:block; margin-top:0.5rem; color:#666;">FÃ¼r ausgegraute IDs existiert bereits ein Beweisfoto von dir.</small>
      </div>

      <div class="form-group">
        <label>Bild</label>
        <div id="drop-zone">
          <span id="drop-text">Bild ablegen oder klicken</span>
          <input type="file" name="image" id="fileInput" hidden accept="image/*" required>
          <img id="preview" src="#" alt="Preview">
        </div>
      </div>

      <button type="submit" class="btn-black submit-btn" id="submitBtn">hochladen</button>
    </form>

  <script>
    const dz = document.getElementById('drop-zone');
    const fi = document.getElementById('fileInput');
    const pr = document.getElementById('preview');
    const dt = document.getElementById('drop-text');

    dz.addEventListener('click', () => fi.click());

    dz.addEventListener('dragover', (e) => {
      e.preventDefault();
      dz.classList.add('active');
    });

    dz.addEventListener('dragleave', () => dz.classList.remove('active'));

    dz.addEventListener('drop', (e) => {
      e.preventDefault();
      dz.classList.remove('active');
      if (e.dataTransfer.files.length) {
        fi.files = e.dataTransfer.files;
        updatePreview(e.dataTransfer.files[0]);
      }
    });

    fi.addEventListener('change', (e) => {
      if (e.target.files.length) updatePreview(e.target.files[0]);
    });

    function updatePreview(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        pr.src = e.target.result;
        pr.style.display = 'block';
        dt.style.display = 'none';
      }
      reader.readAsDataURL(file);
    }

    document.getElementById('uploadForm').onsubmit = function() {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "optimiere...";
    };

    // Prefill number if present in query param
    (function(){
      try {
        const params = new URLSearchParams(location.search);
        const d = params.get('number');
        if (d) {
          const el = document.getElementById('deriveInput');
          if (el) {
            el.value = d;
            // don't leave a disabled (already-uploaded) option selected
            const selectedOpt = el.querySelector('option[value="' + d + '"]');
            if (selectedOpt && selectedOpt.disabled) {
              el.value = '';
            }
          }
        }

        // If redirected after successful upload, clear selection and reset form
        const uploaded = params.get('uploaded');
        if (uploaded === '1') {
          const el = document.getElementById('deriveInput');
          const fileInput = document.getElementById('fileInput');
          const preview = document.getElementById('preview');
          const dropText = document.getElementById('drop-text');
          const submitBtn = document.getElementById('submitBtn');
          // clear selection
          if (el) el.value = '';
          // reset file input & preview
          if (fileInput) {
            try { fileInput.value = null; } catch(e) { /* ignore */ }
          }
          if (preview) {
            preview.src = '#';
            preview.style.display = 'none';
          }
          if (dropText) dropText.style.display = 'block';
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerText = 'hochladen';
          }
          // show temporary success message
          let result = document.getElementById('uploadResult');
          if (!result) {
            result = document.createElement('div');
            result.id = 'uploadResult';
            result.style.marginTop = '1rem';
            result.style.fontWeight = '500';
            document.querySelector('.container.upload').insertBefore(result, document.querySelector('.session-uploads'));
          }
          result.innerText = 'Upload erfolgreich!';
          result.style.color = '#2e7d32';
          result.style.display = 'block';
          setTimeout(() => {
            if (result) result.style.display = 'none';
          }, 4000);

          // Remove uploaded param from URL to avoid repeated behavior on refresh
          try {
            params.delete('uploaded');
            const newUrl = location.pathname + (params.toString() ? '?' + params.toString() : '');
            history.replaceState(null, '', newUrl);
          } catch(e) { /* ignore */ }
        }

      } catch (e) { /* ignore */ }
    })();

  </script>

  <!-- Invitation Modal -->
  <div id="inviteModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:8px; max-width:500px; width:90%; position:relative;">
      <button onclick="document.getElementById('inviteModal').style.display='none'" aria-label="SchlieÃŸen" style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#666;">&times;</button>
      <h3 style="margin-top:0;">Spieler einladen</h3>
      <p>Generiere einen Einladungslink, damit andere Spieler mit dir zusammen spielen kÃ¶nnen.</p>
      <div id="inviteResult"></div>
      <button onclick="generateInvitation()" class="btn-black" id="generateInviteBtn">Einladungslink erstellen</button>
    </div>
  </div>

  <!-- Sessions Modal -->
  <div id="sessionsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; padding:2rem; border-radius:8px; max-width:600px; width:90%; position:relative; max-height:80vh; overflow-y:auto;">
      <button onclick="document.getElementById('sessionsModal').style.display='none'" aria-label="SchlieÃŸen" style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#666;">&times;</button>
      <h3 style="margin-top:0;">Aktive Sessions</h3>
      <div id="sessionsResult"></div>
    </div>
  </div>

  <script>
    // Invitation functionality
    document.getElementById('invitePlayerBtn')?.addEventListener('click', () => {
      document.getElementById('inviteModal').style.display = 'flex';
    });

    document.getElementById('manageSessionsBtn')?.addEventListener('click', async () => {
      document.getElementById('sessionsModal').style.display = 'flex';
      await loadSessions();
    });

    async function generateInvitation() {
      const btn = document.getElementById('generateInviteBtn');
      btn.disabled = true;
      btn.innerText = 'Erstelle...';

      try {
        const response = await fetch('/upload/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (response.ok) {
          const resultDiv = document.getElementById('inviteResult');
          resultDiv.innerHTML = `
            <div style="background:#e8f5e9; padding:1rem; border-radius:4px; margin:1rem 0;">
              <p style="margin:0 0 0.5rem 0;"><strong>Einladung erstellt!</strong></p>
              <p style="margin:0.5rem 0; word-break:break-all;"><strong>Link:</strong> <a href="${data.invitation_url}" target="_blank">${data.invitation_url}</a></p>
              <p style="margin:0.5rem 0; font-size:0.9rem; color:#666;">GÃ¼ltig bis: ${new Date(data.expires_at).toLocaleString('de-DE')}</p>
              <button onclick="copyInviteLink('${data.invitation_url}')" class="btn-black" style="margin-top:0.5rem;">Link kopieren</button>
            </div>
          `;
        } else {
          alert('Fehler beim Erstellen der Einladung: ' + data.error);
        }
      } catch (error) {
        alert('Fehler: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerText = 'Neuen Link erstellen';
      }
    }

    function copyInviteLink(url) {
      navigator.clipboard.writeText(url).then(() => {
        alert('Link in Zwischenablage kopiert!');
      }).catch(() => {
        // Fallback
        const input = document.createElement('input');
        input.value = url;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        alert('Link in Zwischenablage kopiert!');
      });
    }

    async function loadSessions() {
      const resultDiv = document.getElementById('sessionsResult');
      resultDiv.innerHTML = '<p>Lade...</p>';

      try {
        const response = await fetch('/upload/sessions');
        const data = await response.json();

        if (response.ok) {
          if (data.sessions && data.sessions.length > 0) {
            let html = '<ul style="list-style:none; padding:0;">';
            data.sessions.forEach(session => {
              const lastActive = new Date(session.last_activity_at).toLocaleString('de-DE');
              html += `
                <li style="padding:1rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                  <div>
                    <strong>${session.player_name}</strong> ${session.is_current ? '<span style="color:#2e7d32;">(Du)</span>' : ''}
                    <br>
                    <small style="color:#666;">Zuletzt aktiv: ${lastActive}</small>
                  </div>
                  ${!session.is_current ? `<button onclick="revokeSession('${session.session_uuid}')" class="btn-transparent" style="color:#d32f2f;">Entfernen</button>` : ''}
                </li>
              `;
            });
            html += '</ul>';
            resultDiv.innerHTML = html;
          } else {
            resultDiv.innerHTML = '<p>Keine aktiven Sessions gefunden.</p>';
          }
        } else {
          resultDiv.innerHTML = '<p style="color:#d32f2f;">Fehler beim Laden der Sessions.</p>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<p style="color:#d32f2f;">Fehler: ' + error.message + '</p>';
      }
    }

    async function revokeSession(sessionUuid) {
      if (!confirm('MÃ¶chtest du diese Session wirklich entfernen?')) return;

      try {
        const response = await fetch(`/upload/sessions/${sessionUuid}/revoke`, {
          method: 'POST'
        });

        const data = await response.json();

        if (response.ok) {
          alert('Session wurde entfernt');
          await loadSessions();
        } else {
          alert('Fehler: ' + data.error);
        }
      } catch (error) {
        alert('Fehler: ' + error.message);
      }
    }
  </script>

  <!-- Session uploads -->
  {{if .SessionContribs}}
  <div class="session-uploads" style="margin-top:1.5rem;">
    <h3>Deine Uploads in dieser Session</h3>
    <div class="session-grid">
      {{range .SessionContribs}}
      <div class="session-card" id="session-upload-{{index . "id"}}">
        <div class="session-img-wrapper">
          <img class="lazy blur-up" data-src="{{index . "image_url"}}" data-lqip="{{index . "image_lqip"}}" src="{{if index . "image_lqip"}}{{index . "image_lqip"}}{{else}}data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='10' height='6'/>{{end}}" loading="lazy" alt="upload">
        </div>
        <div class="session-meta">ðŸ†” {{index . "number"}}</div>
      </div>
      {{end}}
    </div>
  </div>
  {{end}}
</div>
{{end}}