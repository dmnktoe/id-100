{{define "admin_dashboard.content"}}

<div class="admin-container">
  <div class="admin-header">
    <h1>ğŸ”§ Admin Dashboard</h1>
    <p>Token-Verwaltung und Upload-Ãœbersicht</p>
  </div>

  <div class="admin-tabs">
    <a href="/admin?tab=tokens" class="admin-tab{{if eq .Tab "tokens"}} active{{end}}">ğŸ“± Taschen & Tokens</a>
    <a href="/admin?tab=requests" class="admin-tab{{if eq .Tab "requests"}} active{{end}}">ğŸ‘œ Taschen-Anfragen</a>
    <a href="/admin?tab=contribs" class="admin-tab{{if eq .Tab "contribs"}} active{{end}}">ğŸ“¸ Neueste Contributions</a>
  </div>

  {{if eq .Tab "tokens"}}
  <div id="tab-tokens" class="admin-section">
    <h2>â• Neue Tasche erstellen</h2>
    <div class="token-create-form">
      <form id="createTokenForm" class="token-create-grid">
        <div>
          <label>Taschenname</label>
          <input type="text" id="bagName" placeholder="z.B. Tasche #6" required>
        </div>
        <div>
          <label>Max. Uploads</label>
          <input type="number" id="maxUploads" value="100" min="1" required>
        </div>
        <button type="submit" class="btn-admin btn-activate">
          âœ¨ Erstellen
        </button>
      </form>
      <div id="createResult" class="create-result"></div>
    </div>

    <h2>ğŸ“± Taschen & Tokens</h2>
    {{range .Tokens}}
    <div class="token-card{{if not .IsActive}} inactive{{end}}">
      <div class="token-header">
        <h3>{{.BagName}}{{if .CurrentPlayer}} - {{.CurrentPlayer}}{{end}}</h3>
        <span class="token-status{{if .IsActive}} active{{else}} inactive{{end}}">
          {{if .IsActive}}â— aktiv{{else}}â—‹ inaktiv{{end}}
        </span>
      </div>

      <div class="token-meta">
        <div class="token-meta-item">
          <strong>Uploads</strong>
          <input type="number" id="quota-{{.ID}}" value="{{.MaxUploads}}" min="1" class="token-quota-input">
          <span class="token-quota-remaining">/ {{.TotalUploads}} genutzt</span>
        </div>
        <div class="token-meta-item">
          <strong>Verbleibend</strong>
          {{.Remaining}}
        </div>
        <div class="token-meta-item">
          <strong>Sessions</strong>
          #{{.TotalSessions}}
        </div>
        <div class="token-meta-item">
          <strong>Gestartet</strong>
          {{.SessionStartedAt.Format "02.01. 15:04"}}
        </div>
      </div>

      <div class="token-actions">
        <button class="btn-admin btn-reset" onclick="resetToken({{.ID}}, '{{.BagName}}')">
          ğŸ”„ ZurÃ¼cksetzen
        </button>
        <button class="btn-admin btn-update" onclick="updateQuota({{.ID}})">
          ğŸ’¾ Kontingent speichern
        </button>
        <button class="btn-admin btn-qr-svg"
          onclick="downloadQR({{.ID}}, '{{.BagName}}', 'svg')">
          ğŸ“¥ QR (SVG)
        </button>
        <button class="btn-admin btn-qr-png"
          onclick="downloadQR({{.ID}}, '{{.BagName}}', 'png')">
          ğŸ“¥ QR (PNG)
        </button>
        <button class="btn-admin btn-copy-url"
          onclick="copyUploadURL('{{.Token}}', '{{.BagName}}')">
          ğŸ”— URL kopieren
        </button>
        {{if .IsActive}}
        <button class="btn-admin btn-deactivate" onclick="deactivateToken({{.ID}}, '{{.BagName}}')">
          ğŸš« Deaktivieren
        </button>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
  {{end}}

  {{if eq .Tab "requests"}}
  <div id="tab-requests" class="admin-section">
    <h2>ğŸ‘œ Taschen-Anfragen</h2>
    <div class="filter-controls">
      <a href="/admin?tab=requests&bag_status=all" class="filter-btn {{if or (not .BagStatus) (eq .BagStatus "all")}}active{{end}}">Alle ({{len .BagRequests}})</a>
      <a href="/admin?tab=requests&bag_status=open" class="filter-btn {{if eq .BagStatus "open"}}active{{end}}">Offen ({{.OpenCount}})</a>
      <a href="/admin?tab=requests&bag_status=handled" class="filter-btn {{if eq .BagStatus "handled"}}active{{end}}">Erledigt ({{.HandledCount}})</a>
    </div>

    <div id="bagRequestsContainer" class="bag-requests-container">
      {{if .BagRequests}}
      <ul class="bag-requests-list">
        {{range .BagRequests}}
        <li class="bag-request-item">
          <div>
            <strong class="bag-request-email">{{.Email}}</strong>
            <div class="bag-request-date">{{.CreatedAt.Format "02.01.2006 15:04"}}</div>
          </div>
          <div>
            {{if .Handled}}
            <span class="bag-request-handled">âœ… Erledigt</span>
            {{else}}
            <button class="btn-admin btn-reset" onclick="markBagRequestDone({{.ID}}, this)">âœ… Erledigt</button>
            {{end}}
          </div>
        </li>
        {{end}}
      </ul>
      {{else}}
      <div class="bag-requests-empty">Noch keine Anfragen.</div>
      {{end}}
    </div>
  </div>
  {{end}}

  {{if eq .Tab "contribs"}}
  <div id="tab-contribs" class="admin-section">
    <h2>ğŸ“¸ Neueste Contributions</h2>
    <div class="contrib-grid">
      {{range .RecentContribs}}
      <div class="contrib-card">
        <img src="{{.ImageUrl}}" alt="Contribution" loading="lazy">
        <div class="contrib-meta">
          <div>{{.PlayerName}}</div>
          <div>ID #{{.DeriveNumber}}</div>
        </div>
      </div>
      {{end}}
    </div>
  </div>
  {{end}}
</div>

<script>
  /* eslint-disable */
  // Create new token/bag
  document.getElementById('createTokenForm').onsubmit = async function (e) {
    e.preventDefault();

    const bagName = document.getElementById('bagName').value;
    const maxUploads = parseInt(document.getElementById('maxUploads').value);

    try {
      const response = await fetch('/admin/tokens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ bag_name: bagName, max_uploads: maxUploads })
      });

      const data = await response.json();

      if (response.ok) {
        const resultDiv = document.getElementById('createResult');
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#e8f5e9';
        resultDiv.style.padding = '1rem';
        resultDiv.style.borderRadius = '4px';
        resultDiv.innerHTML = `
        <strong>âœ… Token erstellt!</strong><br>
        <small>Token-ID: ${data.token_id}</small><br>
        <a href="${data.qr_url}?format=svg" target="_blank" style="color: #2196F3;">ğŸ“¥ QR-Code (SVG) herunterladen</a> | 
        <a href="${data.qr_url}?format=png" target="_blank" style="color: #2196F3;">ğŸ“¥ QR-Code (PNG) herunterladen</a><br>
        <small style="word-break: break-all;">URL: ${data.upload_url} <button id="copyNewUrlBtn" style="margin-left:0.5rem; padding:0.2rem 0.4rem; border-radius:4px;">ğŸ”— Kopieren</button></small>
      `;

        document.getElementById('copyNewUrlBtn').onclick = async function () {
          try {
            await navigator.clipboard.writeText(data.upload_url);
            alert('URL kopiert');
          } catch (err) {
            prompt('URL kopieren:', data.upload_url);
          }
        };

        // Reload nach 3 Sekunden
        setTimeout(() => location.reload(), 3000);
      } else {
        alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
      }
    } catch (err) {
      alert('Fehler: ' + err.message);
    }
  };

  async function resetToken(id, name) {
    if (!confirm(`${name} wirklich zurÃ¼cksetzen? Der Upload-Counter wird auf 0 gesetzt.`)) return;

    try {
      const response = await fetch(`/admin/tokens/${id}/reset`, { method: 'POST' });
      const data = await response.json();
      alert(data.message || 'Token wurde zurÃ¼ckgesetzt');
      location.reload();
    } catch (err) {
      alert('Fehler: ' + err.message);
    }
  }

  async function deactivateToken(id, name) {
    if (!confirm(`${name} wirklich deaktivieren?`)) return;

    try {
      const response = await fetch(`/admin/tokens/${id}/deactivate`, { method: 'POST' });
      const data = await response.json();
      alert(data.status || 'Token wurde deaktiviert');
      location.reload();
    } catch (err) {
      alert('Fehler: ' + err.message);
    }
  }

  async function updateQuota(id) {
    const newQuota = parseInt(document.getElementById(`quota-${id}`).value);

    if (newQuota <= 0) {
      alert('Kontingent muss grÃ¶ÃŸer als 0 sein');
      return;
    }

    try {
      const response = await fetch(`/admin/tokens/${id}/quota`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ max_uploads: newQuota })
      });

      const data = await response.json();
      alert(`âœ… Kontingent auf ${data.max_uploads} aktualisiert`);
      location.reload();
    } catch (err) {
      alert('Fehler: ' + err.message);
    }
  }

  function downloadQR(id, name, format) {
    const url = `/admin/tokens/${id}/qr?format=${format}`;
    window.open(url, '_blank');
  }

  async function copyUploadURL(token, name) {
    const encodedToken = encodeURIComponent(token);
    const url = `${location.origin}/upload?token=${encodedToken}`;
    try {
      await navigator.clipboard.writeText(url);
      alert('URL kopiert: ' + url);
    } catch (err) {
      // fallback to prompt if clipboard API fails
      prompt('URL kopieren:', url);
    }
  }

  async function markBagRequestDone(id, btn) {
    if (!confirm('Als erledigt markieren?')) return;
    try {
      const res = await fetch(`/admin/bag-requests/${id}/complete`, { method: 'POST' });
      const data = await res.json();
      if (res.ok) {
        const li = btn.closest('li');
        btn.replaceWith((() => { const s = document.createElement('span'); s.style.color = '#4CAF50'; s.style.fontWeight = '600'; s.textContent = 'âœ… Erledigt'; return s; })());
        li.style.opacity = '0.8';
      } else {
        alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
      }
    } catch (err) {
      alert('Fehler: ' + err.message);
    }
  }

  // AJAX filter for bag requests: replace the requests container to avoid full page reload and scrolling to top
  document.addEventListener('click', (e) => {
    const link = e.target.closest('a.filter-btn');
    if (!link) return;
    // only handle links inside the admin section
    if (!link.closest('.admin-section')) return;
    e.preventDefault();

    const href = link.getAttribute('href');
    const fetchUrl = href.includes('?') ? href + '&partial=1' : href + '?partial=1';

    fetch(fetchUrl)
      .then((r) => {
        if (!r.ok) throw new Error('fetch failed');
        return r.text();
      })
      .then((html) => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newContainer = doc.querySelector('#bagRequestsContainer');
        if (!newContainer) {
          // fallback to full navigation
          window.location.href = href;
          return;
        }
        const container = document.getElementById('bagRequestsContainer');
        container.innerHTML = newContainer.innerHTML;
        // update active states on buttons
        document.querySelectorAll('.admin-section a.filter-btn').forEach(a => a.classList.remove('active'));
        link.classList.add('active');
        // update URL without scrolling
        history.pushState(null, '', href);
      })
      .catch((err) => {
        console.error(err);
        window.location.href = href;
      });
  });


</script>
{{end}}
